name: Pi Nightly (deploy + smoke + UI)

on:
  schedule:
    - cron: '0 2 * * *'   # every night at 02:00 Pi time
  workflow_dispatch:

jobs:
  nightly:
    runs-on: [self-hosted, pi]
    env:
      XDG_RUNTIME_DIR: /run/user/1000
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    concurrency:
      group: pi-nightly
      cancel-in-progress: true
    steps:
      - name: Pull latest code
        shell: bash
        run: |
          set -euo pipefail
          cd ~/vinted-ai-cloud
          git fetch --prune origin
          git reset --hard origin/main

      - name: Rebuild env + restart app
        shell: bash
        run: |
          set -euo pipefail
          cd ~/vinted-ai-cloud/pi-app
          python3 -m venv .venv 2>/dev/null || true
          . .venv/bin/activate
          pip install -U pip
          pip install -r requirements.txt
          systemctl --user daemon-reload
          systemctl --user restart vinted-app.service
          sleep 2

      - name: Smoke: health + drafts + pricing
        shell: bash
        run: |
          set -euo pipefail
          curl -sS 127.0.0.1:8080/health | tee /tmp/health.json
          curl -sS 127.0.0.1:8080/api/drafts | head -c 500 | sed 's/$/\n/' | tee /tmp/drafts.txt
          # OK example
          curl -sS -o /tmp/ok.json -w 'HTTP:%{http_code}\n' \
            -H 'Content-Type: application/json' \
            -d '{"title":"Nike hoodie","description":""}' \
            127.0.0.1:8080/api/draft/1/check_price | tee /tmp/price_ok.status
          # Block example
          curl -sS -o /tmp/block.json -w 'HTTP:%{http_code}\n' \
            -H 'Content-Type: application/json' \
            -d '{"title":"cannabis seeds","description":""}' \
            127.0.0.1:8080/api/draft/1/check_price | tee /tmp/price_block.status

      - name: Headless UI shots
        shell: bash
        run: |
          set -euo pipefail
          curl -sS 127.0.0.1:8080/api/uitest/run | tee /tmp/uitest.json

      - name: Discord report
        if: always()
        shell: bash
        run: |
          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then exit 0; fi
          STATUS="${{ job.status }}"
          H=$(cat /tmp/health.json 2>/dev/null || echo '{}')
          OK=$(cat /tmp/price_ok.status 2>/dev/null || echo 'HTTP:000')
          BL=$(cat /tmp/price_block.status 2>/dev/null || echo 'HTTP:000')
          MSG=$(printf '**Nightly:** %s\nHealth: `%s`\nOK: `%s`\nBlock: `%s`' "$STATUS" "$H" "$OK" "$BL")
          printf '{"content":"%s"}' "$(echo "$MSG" | sed 's/"/\"/g')" \
            | curl -sS -H 'Content-Type: application/json' -d @- "$DISCORD_WEBHOOK_URL" >/dev/null || true
