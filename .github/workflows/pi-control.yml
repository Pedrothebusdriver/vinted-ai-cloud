name: Pi Control (issue commands)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  control:
    if: |
      github.event.issue.number == 1 &&
      (startsWith(github.event.comment.body, '/deploy') ||
       startsWith(github.event.comment.body, '/uitest') ||
       startsWith(github.event.comment.body, '/status'))
    runs-on: [self-hosted, pi]
    env:
      XDG_RUNTIME_DIR: /run/user/1000
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    concurrency:
      group: pi-control
      cancel-in-progress: true
    steps:
      - name: Acknowledge on GitHub
        uses: actions/github-script@v7
        with:
          script: |
            const cmd = context.payload.comment.body.trim();
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: `⏱️ Received **${cmd}** — running on the Pi…`
            });

      - name: Run /status
        if: startsWith(github.event.comment.body, '/status')
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking vinted-app + endpoints…"
          systemctl --user status vinted-app.service || true
          curl -sS 127.0.0.1:8080/health || true
          curl -sS 127.0.0.1:8080/openapi.json | jq -r '"/admin routes: " + ( [ .paths | keys[] | select(startswith("/admin/")) ] | join(", ") )' || true

      - name: Run /deploy
        if: startsWith(github.event.comment.body, '/deploy')
        shell: bash
        run: |
          set -euo pipefail
          cd ~/vinted-ai-cloud
          git fetch --prune origin
          git reset --hard origin/main
          cd ~/vinted-ai-cloud/pi-app
          python3 -m venv .venv 2>/dev/null || true
          . .venv/bin/activate
          pip install -U pip
          pip install -r requirements.txt
          systemctl --user daemon-reload
          systemctl --user restart vinted-app.service
          sleep 2
          curl -sS 127.0.0.1:8080/health

      - name: Run /uitest
        if: startsWith(github.event.comment.body, '/uitest')
        shell: bash
        run: |
          set -euo pipefail
          curl -sS 127.0.0.1:8080/api/uitest/run | tee /tmp/uitest.json
          jq -r '.shots[]? // empty' /tmp/uitest.json | xargs -r -I{} echo "::notice::Saved {}"

      - name: Post result to GitHub + Discord
        if: always()
        shell: bash
        run: |
          # Summarise
          STATUS="${{ job.status }}"
          LOG_SNIP="$(journalctl --user -u vinted-app.service -n 30 --no-pager 2>/dev/null || true)"
          echo "Status: $STATUS"
          # GitHub note
          gh api repos/${{ github.repository }}/issues/1/comments \
            -f body="$(printf 'Result: **%s**\n\n```\n%s\n```' "$STATUS" "$LOG_SNIP")"
          # Discord
          if [ -n "${DISCORD_WEBHOOK_URL:-}" ]; then
            printf '{"content":"**Pi Control**: %s\\n```%s```"}' "$STATUS" "$(echo "$LOG_SNIP" | sed 's/"/\"/g')" \
              | curl -sS -H 'Content-Type: application/json' -d @- "$DISCORD_WEBHOOK_URL" >/dev/null || true
          fi
