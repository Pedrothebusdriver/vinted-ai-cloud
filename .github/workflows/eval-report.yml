name: Eval & Report (Discord)
on:
  workflow_dispatch: {}

jobs:
  eval:
    runs-on: [self-hosted, pi]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Pick newest manifest
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          mf="$(ls -1t .agent/sampler/manifest-*.json 2>/dev/null | head -1 || true)"
          if [ -z "${mf}" ]; then
            echo "No manifest found"; exit 1
          fi
          echo "Using $mf"
          echo "manifest=$mf" >> "$GITHUB_OUTPUT"

      - name: Post preview to Discord (robust link posts)
        env:
          WEBHOOK: ${{ secrets.DISCORD_AI_TEST_WEBHOOK }}
          MANIFEST: ${{ steps.pick.outputs.manifest }}
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os, time, urllib.request as u, urllib.error

          wh = os.environ.get("WEBHOOK")
          mf = os.environ["MANIFEST"]
          if not wh:
            raise SystemExit("Missing secret DISCORD_AI_TEST_WEBHOOK")
          if not os.path.exists(mf):
            raise SystemExit(f"Manifest not found: {mf}")

          data = json.load(open(mf, "r", encoding="utf-8"))

          # collect a handful of HTTPS image links
          picks = []
          for b in data.get("buckets", []):
              bucket = b.get("bucket", "unknown")
              for it in b.get("items", []):
                  url = (it.get("thumbnail") or it.get("url") or it.get("landing") or "").strip()
                  if not url.startswith("https://"):
                      continue
                  title = (it.get("title") or bucket).strip()
                  picks.append((bucket, title, url))
          if not picks:
              raise SystemExit("No HTTPS image links found in manifest")

          picks = picks[:5]  # keep it tidy

          def post(content: str):
              body = {"content": content}
              req = u.Request(wh, data=json.dumps(body).encode("utf-8"),
                              headers={"Content-Type": "application/json"})
              with u.urlopen(req, timeout=20) as r:
                  print("Discord:", r.status)

          # header
          post(f"**Eval preview:** `{os.path.basename(mf)}`")

          # 1 message per image so Discord unfurls each URL reliably
          for bucket, title, url in picks:
              msg = f"bucket: `{bucket}` â€” {title}\n{url}"
              try:
                  post(msg)
                  time.sleep(0.8)
              except urllib.error.HTTPError as e:
                  # fallback: shorten title if Discord complains
                  post(f"bucket: `{bucket}`\n{url}")
                  time.sleep(0.8)
          PY
