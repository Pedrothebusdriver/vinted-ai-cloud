name: Eval & Report (Discord)
on:
  workflow_dispatch: {}

jobs:
  eval:
    runs-on: [self-hosted, pi]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Pick newest manifest
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          mf="$(ls -1t .agent/sampler/manifest-*.json 2>/dev/null | head -1 || true)"
          if [ -z "${mf}" ]; then
            echo "No manifest found"; exit 1
          fi
          echo "Using $mf"
          echo "manifest=$mf" >> "$GITHUB_OUTPUT"

      - name: Post preview to Discord (embeds from manifest URLs)
        env:
          WEBHOOK: ${{ secrets.DISCORD_AI_TEST_WEBHOOK }}
          MANIFEST: ${{ steps.pick.outputs.manifest }}
        shell: bash
        run: |
          python3 - <<'PY'
          import json, os, time, urllib.request, urllib.error

          wh = os.environ.get("WEBHOOK")
          mf = os.environ["MANIFEST"]
          if not wh:
            raise SystemExit("Missing secret DISCORD_AI_TEST_WEBHOOK")

          data = json.load(open(mf, "r", encoding="utf-8"))

          items = []
          for b in data.get("buckets", []):
              bucket = b.get("bucket", "unknown")
              for it in b.get("items", []):
                  url = it.get("thumbnail") or it.get("url") or it.get("landing")
                  if not url:
                      continue
                  title = (it.get("title") or bucket)[:240]
                  items.append({"bucket": bucket, "title": title, "url": url})

          if not items:
              raise SystemExit("Manifest has 0 usable items")

          # keep it tidy: post first 6 as two messages (3 embeds each)
          items = items[:6]

          def send(embeds, header=None):
              body = {"content": header or "", "embeds": embeds}
              req = urllib.request.Request(
                  wh,
                  data=json.dumps(body).encode("utf-8"),
                  headers={"Content-Type": "application/json"},
              )
              with urllib.request.urlopen(req, timeout=15) as r:
                  print("Discord:", r.status, r.read().decode())

          for i in range(0, len(items), 3):
              chunk = items[i:i+3]
              embeds = [{
                  "title": it["title"],
                  "description": f"bucket: {it['bucket']}",
                  "image": {"url": it["url"]},
              } for it in chunk]
              send(embeds, header=f"Eval preview from `{os.path.basename(mf)}`")
              time.sleep(1)
          PY
