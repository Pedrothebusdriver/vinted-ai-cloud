name: Eval & Report (Discord)
on:
  workflow_dispatch: {}

jobs:
  eval:
    runs-on: [self-hosted, pi]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Pick latest manifest
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          m=$(ls -1t .agent/sampler/manifest-*.json 2>/dev/null | head -n1 || true)
          if [ -z "${m}" ]; then
            echo "No manifest files in .agent/sampler" >&2
            echo "manifest=" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "Using manifest: ${m}"
          echo "manifest=${m}" >> $GITHUB_OUTPUT

      - name: Show manifest header
        if: always()
        run: |
          if [ -n "${{ steps.pick.outputs.manifest }}" ]; then
            head -n 40 "${{ steps.pick.outputs.manifest }}" || true
          fi

      - name: Post preview to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_AI_TEST_WEBHOOK }}
          MANIFEST: ${{ steps.pick.outputs.manifest }}
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os, time, urllib.request as u
          wh = os.environ.get("WEBHOOK")
          mf = os.environ.get("MANIFEST") or ""
          if not wh:
              raise SystemExit("Missing secret DISCORD_AI_TEST_WEBHOOK")
          if not mf or not os.path.exists(mf):
              raise SystemExit(f"Manifest not found: {mf}")

          data = json.load(open(mf, "r", encoding="utf-8"))
          picks = []
          for b in data.get("buckets", []):
              bucket = b.get("bucket","unknown")
              for it in b.get("items", []):
                  url = (it.get("thumbnail") or it.get("url") or it.get("landing") or "").strip()
                  if url.startswith("https://"):
                      title = (it.get("title") or bucket).strip()
                      picks.append((bucket, title, url))
          if not picks:
              raise SystemExit("No HTTPS image links found in manifest")

          picks = picks[:5]

          def post(text):
              body = {"content": text}
              req = u.Request(wh, data=json.dumps(body).encode("utf-8"),
                              headers={"Content-Type":"application/json"})
              with u.urlopen(req, timeout=20) as r:
                  print("Discord:", r.status)

          from os.path import basename
          post(f"**Eval preview:** `{basename(mf)}` ({len(picks)} imgs)")
          time.sleep(0.5)
          for bucket, title, url in picks:
              post(f"bucket:`{bucket}` â€” {title}\n{url}")
              time.sleep(0.8)
          PY
