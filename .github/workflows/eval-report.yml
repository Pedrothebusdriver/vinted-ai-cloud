name: Eval & Report (Discord)
on: { workflow_dispatch: {} }

jobs:
  eval:
    runs-on: [self-hosted, pi]
    steps:
      - uses: actions/checkout@v4
        with: { persist-credentials: false, fetch-depth: 0 }

      - name: Find latest sampler manifest
        id: mf
        shell: bash
        run: |
          set -euo pipefail
          f=$(ls -1 .agent/sampler/manifest-*.json 2>/dev/null | tail -n1 || true)
          if [ -z "${f:-}" ]; then
            echo "No manifest found"; exit 1
          fi
          echo "manifest=$f" >> "$GITHUB_OUTPUT"
          echo "Using manifest: $f"

      - name: Download a few images from manifest
        id: grab
        env: { MF: ${{ steps.mf.outputs.manifest }} }
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os, urllib.request as u, pathlib, random, sys
          mf = os.environ["MF"]
          data = json.load(open(mf))
          items = []
          for b in data.get("buckets", []):
              items += b.get("items", [])[:2]           # up to 2 per bucket
          random.shuffle(items)
          items = items[:6]                             # at most 6 total

          outdir = "/tmp/sampler"
          os.makedirs(outdir, exist_ok=True)
          kept = []
          for i, it in enumerate(items):
              url = it.get("url")
              if not url: 
                  continue
              fn = os.path.join(outdir, f"img{i}.jpg")
              try:
                  u.urlretrieve(url, fn)
                  if os.path.getsize(fn) <= 8000000:   # Discord 8MB limit
                      kept.append((fn, it.get("title",""), it.get("landing","")))
              except Exception:
                  pass
          open(os.path.join(outdir,"list.txt"),"w").write(
              "\n".join("\t".join([p,t,l]) for p,t,l in kept)
          )
          print(f"KEPT={len(kept)}")
          PY

      - name: Post images to Discord
        env:
          HOOK: ${{ secrets.DISCORD_WEBHOOK_AI_TEST }}
        run: |
          set -euo pipefail
          if [ -z "$HOOK" ]; then echo "Missing DISCORD_WEBHOOK_AI_TEST"; exit 1; fi
          LIST=/tmp/sampler/list.txt
          if [ ! -s "$LIST" ]; then echo "No images to post"; exit 0; fi
          n=0
          while IFS=$'\t' read -r path title landing; do
            [ -f "$path" ] || continue
            # keep payload simple to avoid JSON escape issues
            curl -sS -F "payload_json={\"content\":\"ðŸ“· Openverse sample\"}" \
                      -F "file=@${path}" "$HOOK" -o /dev/null
            n=$((n+1))
            [ $n -ge 3 ] && break   # post up to 3 previews per run
          done < "$LIST"
          echo "Posted $n image(s)"
